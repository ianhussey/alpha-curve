---
title: "Alpha curve"
subtitle: "Analyses"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE)

```

# Dependencies

```{r}

library(tidyverse)

```

# Get data

```{r}

data_processed <- read_csv("../../data/processed/data_processed.csv")

data_processed_trimmed <- data_processed |>
  drop_na()

```

# Descriptives

```{r}

n_doi <- data_processed |>
  distinct(doi) |>
  count(name = "n_doi") 

n_doi

n_alphas <- data_processed_trimmed |>
  count(name = "n_alphas")

n_alphas

proportion_with_alpha <- 
  janitor::round_half_up(pull(n_alphas, n_alphas) / pull(n_doi, n_doi), 2)

print(paste("proportion with alpha =", proportion_with_alpha))

```

# Plot alpha curve

```{r}

#scales::viridis_pal()(9)[5]

# ggplot(data_processed_trimmed, aes(x = alpha)) +
#   geom_vline(xintercept = c(0.7, 0.8, 0.9), linetype = "dotted") +
#   geom_histogram(binwidth = 0.01, fill = "#21908CFF") +
#   scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
#                      labels = seq(from = 0, to = 1, by = 0.1),
#                      minor_breaks = NULL) +
#   scale_y_continuous(breaks = seq(from = 0, to = 500, by = 100),
#                      labels = seq(from = 0, to = 500, by = 100)) +
#   theme_bw() +
#   labs(x = expression("Cronbach's" ~ alpha),
#        y = "Count")

ggplot(data_processed_trimmed, aes(x = alpha)) +
  geom_vline(xintercept = c(0.7, 0.8, 0.9), linetype = "dotted") +
  geom_histogram(aes(y = ..density..), binwidth = 0.01, fill = "#21908CFF") +
  geom_density(col = "black", adjust = 1.45) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                     labels = seq(from = 0, to = 1, by = 0.1),
                     minor_breaks = NULL) +
  # scale_y_continuous(breaks = seq(from = 0, to = 500, by = 100),
  #                    labels = seq(from = 0, to = 500, by = 100)) +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha),
       y = "Kernal density")

```

# Plot stacked alpha curve

```{r}

data_processed_recentered <- 
  data_processed_trimmed |>
  mutate(tranch = case_when(              alpha <= .65 ~ "0.00 < alpha <= 0.65",
                            .65 < alpha & alpha <= .75 ~ "0.65 < alpha <= 0.75",
                            .75 < alpha & alpha <= .85 ~ "0.75 < alpha <= 0.85",
                            .85 < alpha & alpha <= .95 ~ "0.85 < alpha <= 0.95",
                            .95 < alpha                ~ "0.95 < alpha <= 1.00")) |>
  mutate(alpha_centered = case_when(tranch == "0.65 < alpha <= 0.75" ~ alpha - .7,
                                    tranch == "0.75 < alpha <= 0.85" ~ alpha - .8,
                                    tranch == "0.85 < alpha <= 0.95" ~ alpha - .9,
                                    TRUE ~ NA_real_))

data_processed_recentered |>
  filter(alpha_centered > -0.045) |>
  ggplot(aes(x = alpha_centered, fill = fct_rev(tranch))) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_histogram(position = "stack", binwidth = 0.01) +
  scale_x_continuous(breaks = seq(from = -0.05, to = 0.06, by = 0.01),
                     labels = seq(from = -0.05, to = 0.06, by = 0.01)) +
  coord_cartesian(xlim = c(-0.045, 0.055)) +
  labs(fill = "Tranch") +
  scale_fill_viridis_d(begin = 0.3, 
                       end = 0.7,
                       option = "magma",
                       labels = c(expression("0.85 <" ~ alpha ~ "<= 0.95"),
                                  expression("0.75 <" ~ alpha ~ "<= 0.85"),
                                  expression("0.65 <" ~ alpha ~ "<= 0.75"))) +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha ~ "(centered within each tranch)"),
       y = "Count")

```

# Beta regression

```{r}

# sultion from https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#interpreting-coefficients

library(broom)            
library(betareg)          
library(extraDistr)       

model_beta <- data_processed_trimmed |>
  mutate(alpha = janitor::round_half_up(alpha, 2),
         alpha = case_when(alpha == 0 ~ 0.01,
                           alpha == 1 ~ 0.99,
                           TRUE ~ alpha)) |>
  betareg(alpha ~ 1 | 1, data = _, 
          link = "logit")

beta_mu_intercept <- model_beta %>% 
  tidy() %>% 
  filter(component == "mean", term == "(Intercept)") %>% 
  pull(estimate)

# # average alpha according to model
# plogis(beta_mu_intercept)
# ## [1] 0.8174543

beta_phi_intercept <- model_beta %>% 
  tidy() %>% 
  filter(component == "precision", term == "(Intercept)") %>% 
  pull(estimate)

# plot histogram and beta regression fit
ggplot(data = tibble(alpha = 0:1), aes(x = alpha)) + 
  geom_histogram(data = data_processed_trimmed,
                 aes(y = ..density..), 
                 binwidth = 0.01, 
                 fill = "#21908CFF") +
  stat_function(fun = extraDistr::dprop, size = 1,
                args = list(size = exp(beta_phi_intercept), 
                            mean = plogis(beta_mu_intercept))) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                     labels = seq(from = 0, to = 1, by = 0.1),
                     minor_breaks = NULL) +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha),
       y = "Density")

```

## Residuals


### Ruben's approach
```{r}

frequency <- data_processed_trimmed %>% 
  mutate(alpha = janitor::round_half_up(alpha, 2),
         alpha = case_when(alpha == 0 ~ 0.01,
                           alpha == 1 ~ 0.99,
                           TRUE ~ alpha)) %>% 
  mutate(n_total = n()) %>% 
  group_by(alpha) %>% 
  summarise(freq = n()/first(n_total))

ggplot(frequency, aes(alpha, freq)) + 
  geom_col()

frequency$fitted <- extraDistr::dprop(x = frequency$alpha, size = exp(beta_phi_intercept), 
                            mean = plogis(beta_mu_intercept))

frequency <- frequency %>% 
  mutate(residual = freq*100 - fitted)

ggplot(frequency, aes(alpha)) + 
  geom_col(aes(y = freq*100)) +
  geom_line(aes(y = fitted))

diff <- frequency %>% 
  mutate(frequency = 100*freq,
         frequencyworesidual = if_else(residual > 0, frequency - residual, frequency),
         pos_resid = residual > 0,
         residual = if_else(residual > 0, residual, -1 * residual)) %>% 
  select(alpha,fitted, pos_resid, frequencyworesidual, residual) %>% 
  pivot_longer(c(-alpha, -fitted, -pos_resid))

diff %>%  
  mutate(name = factor(case_when(
    name == "frequencyworesidual" ~ "3", 
    pos_resid ~ "2",
    TRUE ~ "1"))) %>% 
ggplot(., aes(alpha)) + 
  geom_vline(xintercept = c(0.7, 0.8, 0.9), linetype = "dotted") +
  geom_col(aes(y = value, fill = name), position = "stack") +
  scale_fill_manual(values = c("3" = "gray", "2" = "#a46657", "1" = "#697d4f"), guide = "none") +
  geom_step(aes(y = fitted))

ggplot(frequency, aes(alpha, residual, fill = residual > 0)) + 
  geom_vline(xintercept = c(0.7, 0.8, 0.9), linetype = "dotted") +
  geom_col()
```


Needs work

```{r}

data_pred <- data_processed_trimmed |>
  dplyr::select(alpha) |>
  mutate(residuals_deviance = residuals(model_beta, type = "deviance"),
         residuals_sweighted2 = residuals(model_beta, type = "sweighted2")) |>
  arrange(alpha) |>
  distinct(alpha, .keep_all = TRUE)

ggplot(data_pred, aes(alpha, residuals_deviance)) +
  geom_point()

ggplot(data_pred, aes(alpha, residuals_sweighted2)) +
  geom_point()

```

# Session info

```{r}

sessionInfo()

```
