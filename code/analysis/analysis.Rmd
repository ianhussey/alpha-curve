---
title: "Alpha curve"
subtitle: "Analyses"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE)

```

# Dependencies

```{r}

library(tidyverse)
library(broom)            
library(betareg)          
library(extraDistr) 
library(patchwork)

```

# Get data

```{r}

data_processed <- read_csv("../../data/processed/data_processed.csv")

data_processed_trimmed <- data_processed |>
  drop_na() %>% 
  filter(two_or_more_decimals)

```

# Descriptives

```{r}

n_doi <- data_processed |>
  distinct(doi) |>
  count(name = "n_doi") 

paste("n articles =", 
      n_doi)


n_exclusions <- data_processed |>
  filter(exclude_master == TRUE) |>
  count(name = "n_exclusions")

paste("n exclusions =", 
      n_exclusions)


n_estimates_after_exclusions <- data_processed_trimmed |>
  count(name = "n_estimates")

paste("n alpha estimates after exclusions =", 
      n_estimates_after_exclusions)


proportion_with_valid_alpha <- 
  janitor::round_half_up(pull(n_estimates_after_exclusions, n_estimates) / pull(n_doi, n_doi), 2)

paste("proportion of articles with 1+ alpha estimates after exclusions =",
      proportion_with_valid_alpha)

```

# Kernel smoothing

```{r fig.height=6, fig.width=6}

```{r fig.height=5, fig.width=6}

# create tibble containing all alpha bins, for a later join
all_alphas <- tibble(alpha = as.character(seq(0.01, 0.99, 0.01)),
                     freq = 0,
                     missing = TRUE)

data_frequency_temp <- data_processed_trimmed %>%
  # round the alpha values to 2 decimal places, using standard rounding method
  # recode alpha values of 0 or 1 to .01 or .99, in order to be able to fit beta regerssion
  # nb non present
  mutate(alpha = janitor::round_half_up(alpha, 2),
         alpha = case_when(alpha == 0 ~ 0.01,
                           alpha == 1 ~ 0.99,
                           TRUE ~ alpha)) %>% 
  mutate(n_total = n()) %>% 
  group_by(alpha) %>% 
  summarise(freq = sum(!is.na(alpha))/first(n_total)) %>%
  # convert alpha to character to facilitate a join later
  mutate(alpha = as.character(alpha))

# kernel density estimation
data_density <- density(data_processed_trimmed$alpha,
                        n      = length(seq(0.01, 0.99, 0.01)),
                        from   = 0.01,
                        to     = 0.99,
                        kernal = "gaussian",
                        adjust = 2)

data_frequency_temp2 <-
  # join the previous two tibbles to create a complete list of alpha bins
  data_frequency_temp %>%
  bind_rows(all_alphas %>% anti_join(data_frequency_temp, by = "alpha")) %>%
  arrange(alpha, desc(freq)) %>%
  distinct(alpha, .keep_all = TRUE)
  
# ggplot(data_frequency, aes(alpha, freq)) + 
#   geom_col()

temp <- density(data_processed_trimmed$alpha[which(! data_processed_trimmed$alpha %in% c(0.7, 0.8, 0.9))],
                n = length(seq(0.01, 0.99, 0.01)),
                from = 0.01,
                to = 0.99, bw = 0.05)

data_frequency$density <- temp$y

# # for adding fitted values from a beta regression instead of kernel density estimation
# data_frequency_temp2$fitted <-
#   extraDistr::dprop(x = data_frequency_temp2$alpha,
#                     size = exp(beta_phi_intercept),
#                     mean = plogis(beta_mu_intercept))
# data_frequency_temp2$fitted <- dbeta(x = data_frequency_temp2$alpha, shape2 =  (beta_phi_intercept),
# shape1 = (beta_mu_intercept))

data_frequency <- data_frequency_temp2 %>%
  mutate(residual = freq*100 - density,
         alpha = as.numeric(alpha),
         missing = ifelse(is.na(missing), FALSE, missing))

data_diff <- data_frequency %>%
  mutate(frequency = 100*freq,
         frequency_without_residual = if_else(residual > 0, frequency - residual, frequency),
         pos_resid = residual > 0,
         residual = if_else(residual > 0, residual, -1 * residual)) %>%
  dplyr::select(alpha,
                #fitted,
                density,
                pos_resid,
                frequency_without_residual,
                residual) %>%
  pivot_longer(c(frequency_without_residual, residual))


color_1 <- scales::viridis_pal()(11)[3]
color_2 <- scales::viridis_pal()(11)[7]

total_n <- nrow(data_processed_trimmed)/100

p1 <-
  data_diff %>%  
  mutate(name = factor(case_when(
    name == "frequency_without_residual" ~ "3",
    pos_resid ~ "2",
    TRUE ~ "1"))
  ) %>% 
  ggplot(., aes(alpha, y = value * total_n, fill = name)) + 
  geom_vline(xintercept = c(0.7, 0.8, 0.9), linetype = "dotted") +
  geom_col(position = "stack") +
  geom_step(aes(y = density * total_n, group = 1), direction = "mid") +
  ggrepel::geom_text_repel(aes(y = value * total_n, label = if_else(name %in% c("2", "1") & alpha %in% c(0.7, 0.8, 0.9), round(value*total_n), NA_real_)), position = "stack") +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                     labels = seq(from = 0, to = 1, by = 0.1),
                     minor_breaks = NULL) +
  scale_fill_manual(values = c("3" = "darkgray", "2" = color_2, "1" = color_1),
                    guide = "none") +
  scale_alpha_manual(values = c("3" = 0.35, "2" = 1, "1" = 1)) +
  #scale_fill_viridis_d(begin = .3, end = .7) +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha),
       y = "n alphas")

p2 <- 
  ggplot(data_frequency, aes(alpha, residual * total_n, fill = residual > 0)) + 
  geom_vline(xintercept = c(0.7, 0.8, 0.9), linetype = "dotted") +
  geom_col() +
  scale_fill_manual(values = c("TRUE" = color_2, "FALSE" = color_1), guide = "none") +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha),
       y = "Residual") +
  theme(legend.position = "none")

p1 + p2 + plot_layout(nrow = 2, heights = c(0.7, 0.3))
```

```{r}

data_inflation <- data_frequency %>%
  #filter(alpha %in% c(.69, .70, .79, .80, .89, .90)) %>%
  select(alpha, observed = freq, predicted = density, residual, missing) %>%
  mutate(predicted = predicted/100,
         residual = residual/100,
         inflation = observed/predicted) %>%
  janitor::round_half_up(digits = 3) %>%
  mutate(group = as.factor(case_when(alpha %in% c(.70, .80, .90) ~ "cutoff",
                                     TRUE ~ "non cutoff")))

#knitr::kable(data_inflation)

```

- There were `r (data_inflation$inflation[data_inflation$alpha == 0.69] - 1)*100`% fewer observations of Cronbach's $a$ = .69 and  `r (data_inflation$inflation[data_inflation$alpha == 0.70] - 1)*100`% more observations of Cronbach's $a$ = .70 than predicted.
- There were `r (data_inflation$inflation[data_inflation$alpha == 0.79] - 1)*100`% fewer observations of Cronbach's $a$ = .79 and `r (data_inflation$inflation[data_inflation$alpha == 0.80] - 1)*100`% more observations of Cronbach's $a$ = .80 than predicted.
- There were `r (data_inflation$inflation[data_inflation$alpha == 0.89] - 1)*100`% fewer observations of Cronbach's $a$ = .89 and `r (data_inflation$inflation[data_inflation$alpha == 0.90] - 1)*100`% more observations of Cronbach's $a$ = .90 than predicted.

### Permutation test

```{r}

# sultion from https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#interpreting-coefficients

model_beta <- data_processed_trimmed |>
  mutate(alpha = janitor::round_half_up(alpha, 2),
         alpha = case_when(alpha == 0 ~ 0.01,
                           alpha == 1 ~ 0.99,
                           TRUE ~ alpha)) %>%
  filter(!alpha %in% c(0.4, 0.5, 0.6, 0.7, 0.8, 0.9)) %>%
  betareg(alpha ~ 1 | 1, data = .,
          link = "logit")

beta_mu_intercept <- model_beta %>%
  tidy() %>%
  filter(component == "mean", term == "(Intercept)") %>%
  pull(estimate)

# # average alpha according to model
# plogis(beta_mu_intercept)
# ## [1] 0.8174543

beta_phi_intercept <- model_beta %>%
  tidy() %>%
  filter(component == "precision", term == "(Intercept)") %>%
  pull(estimate)

# plot histogram and beta regression fit
ggplot(data = tibble(alpha = 0:1), aes(x = alpha)) +
  geom_histogram(data = data_processed_trimmed,
                 aes(y = ..density..),
                 binwidth = 0.01,
                 fill = "#21908CFF") +
  stat_function(fun = extraDistr::dprop, size = 1,
                args = list(size = exp(beta_phi_intercept),
                            mean = plogis(beta_mu_intercept))) +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                     labels = seq(from = 0, to = 1, by = 0.1),
                     minor_breaks = NULL) +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha),
       y = "Density")

```

## Using non threshold data points

```{r}
data_frequency$density <-
  extraDistr::dprop(x = data_frequency$alpha,
                    size = exp(beta_phi_intercept),
                    mean = plogis(beta_mu_intercept))

data_frequency <- data_frequency %>%
  mutate(residual = freq*100 - density,
         alpha = as.numeric(alpha))

data_frequency <- data_frequency_temp2 %>%
  mutate(residual = freq*100 - density,
         alpha = as.numeric(alpha),
         missing = ifelse(is.na(missing), FALSE, missing))

diff <- data_frequency %>%
  mutate(frequency = 100*freq,
         frequency_without_residual = if_else(residual > 0, frequency - residual, frequency),
         pos_resid = residual > 0,
         residual = if_else(residual > 0, residual, -1 * residual)) %>%
  dplyr::select(alpha,
                #fitted,
                density,
                pos_resid,
                frequencyworesidual,
                residual) %>%
  pivot_longer(c(frequencyworesidual, residual))


color_1 <- scales::viridis_pal()(11)[3]
color_2 <- scales::viridis_pal()(11)[7]

total_n <- nrow(data_processed_trimmed)/100

p1 <-
  diff %>%  
  mutate(name = factor(case_when(
    name == "frequency_without_residual" ~ "3",
    pos_resid ~ "2",
    TRUE ~ "1"))
  ) %>%
  ggplot(., aes(alpha, y = value * total_n, fill = name)) +
  geom_vline(xintercept = c(0.7, 0.8, 0.9), linetype = "dotted") +
  geom_col(position = "stack") +
  geom_step(aes(y = density * total_n, group = 1), direction = "mid") +
  ggrepel::geom_text_repel(aes(y = value * total_n, label = if_else(name %in% c("2", "1") & alpha %in% c(0.7, 0.8, 0.9), round(value*total_n), NA_real_)), position = "stack") +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.1),
                     labels = seq(from = 0, to = 1, by = 0.1),
                     minor_breaks = NULL) +
  scale_fill_manual(values = c("3" = "lightgray", "2" = color_2, "1" = color_1), guide = "none") +
  #scale_fill_viridis_d(begin = .3, end = .7) +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha),
       y = "n alphas")

p2 <-
  ggplot(data_frequency, aes(alpha, residual * total_n, fill = residual > 0)) +
  geom_vline(xintercept = c(0.7, 0.8, 0.9), linetype = "dotted") +
  geom_col() +
  scale_fill_manual(values = c("TRUE" = color_2, "FALSE" = color_1), guide = "none") +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha),
       y = "Residual") +
  theme(legend.position = "none")

p1 + p2 + plot_layout(nrow = 2, heights = c(0.7, 0.3))

```

# Stacked alphas

## Plot

```{r}

data_processed_recentered <-
  data_processed_trimmed |>
  mutate(tranch = case_when(              alpha <= .65 ~ "0.00 < alpha <= 0.65",
                            .65 < alpha & alpha <= .75 ~ "0.65 < alpha <= 0.75",
                            .75 < alpha & alpha <= .85 ~ "0.75 < alpha <= 0.85",
                            .85 < alpha & alpha <= .95 ~ "0.85 < alpha <= 0.95",
                            .95 < alpha                ~ "0.95 < alpha <= 1.00")) |>
  mutate(alpha_centered = case_when(tranch == "0.65 < alpha <= 0.75" ~ alpha - .7,
                                    tranch == "0.75 < alpha <= 0.85" ~ alpha - .8,
                                    tranch == "0.85 < alpha <= 0.95" ~ alpha - .9,
                                    TRUE ~ NA_real_))

data_processed_recentered |>
  filter(alpha_centered > -0.045) |>
  ggplot(aes(x = alpha_centered, fill = fct_rev(tranch))) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_histogram(position = "stack", binwidth = 0.01) +
  scale_x_continuous(breaks = seq(from = -0.05, to = 0.06, by = 0.01),
                     labels = seq(from = -0.05, to = 0.06, by = 0.01)) +
  coord_cartesian(xlim = c(-0.045, 0.055)) +
  labs(fill = "Tranch") +
  scale_fill_viridis_d(begin = 0.3,
                       end = 0.7,
                       option = "magma",
                       labels = c(expression("0.85 <" ~ alpha ~ "<= 0.95"),
                                  expression("0.75 <" ~ alpha ~ "<= 0.85"),
                                  expression("0.65 <" ~ alpha ~ "<= 0.75"))) +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha ~ "(centered within each tranch)"),
       y = "Count")

data_processed_recentered |>
  mutate(alpha_centered = janitor::round_half_up(alpha_centered, 2)) %>%
  filter(tranch %in% c("0.65 < alpha <= 0.75",
                       "0.75 < alpha <= 0.85",
                       "0.85 < alpha <= 0.95") &
           alpha_centered %in% c(-0.01, 0.00)) %>%  
  ggplot(aes(x = alpha_centered)) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_histogram(binwidth = 0.01) +
  facet_wrap(~tranch)
  scale_x_continuous(breaks = seq(from = -0.05, to = 0.06, by = 0.01),
                     labels = seq(from = -0.05, to = 0.06, by = 0.01)) +
  coord_cartesian(xlim = c(-0.045, 0.055)) +
  labs(fill = "Tranch") +
  scale_fill_viridis_d(begin = 0.3,
                       end = 0.7,
                       option = "magma",
                       labels = c(expression("0.85 <" ~ alpha ~ "<= 0.95"),
                                  expression("0.75 <" ~ alpha ~ "<= 0.85"),
                                  expression("0.65 <" ~ alpha ~ "<= 0.75"))) +
  theme_bw() +
  labs(x = expression("Cronbach's" ~ alpha ~ "(centered within each tranch)"),
       y = "Count")

```

## Test

```{r}

dat <- data_processed_recentered %>%
  mutate(alpha_centered = janitor::round_half_up(alpha_centered, 2)) %>%
  select(tranch, alpha_centered) %>%
  filter(tranch %in% c("0.65 < alpha <= 0.75",
                       "0.75 < alpha <= 0.85",
                       "0.85 < alpha <= 0.95") &
           alpha_centered %in% c(-0.01, 0.00)) %>%
  mutate(alpha_centered = case_when(alpha_centered == -0.01 ~ "before_cutoff",
                                    alpha_centered == 0.00 ~ "at_cutoff"))

chisq.test()

library(janitor)
tab <- tabyl(dat, tranch, alpha_centered)
janitor::chisq.test(tab)
janitor::chisq.test(tab)$residuals

```

# Session info

```{r}

sessionInfo()

```
